<div class="order-list-container">
  <h2>Pedidos</h2>

  <div *ngIf="isLoading" class="loading-indicator">
    <div class="skeleton-grid">
      <div class="skeleton-row" *ngFor="let s of [1,2,3]"></div>
    </div>
  </div>

  <div *ngIf="errorMensaje && !isLoading" class="error-mensaje">
    <p>{{ errorMensaje }}</p>
    <button type="button" class="btn" (click)="loadOrders()" aria-label="Reintentar carga">Reintentar</button>
  </div>

  <div *ngIf="!isLoading && !errorMensaje && pedidos.length === 0" class="no-orders-mensaje">
    <p>Aún no tienes pedidos.</p>
    <button class="btn btn-primary" (click)="goToStore()">Explorar Cuentos</button>
  </div>

  <div *ngIf="!isLoading && !errorMensaje && pedidos.length > 0" class="filter-bar">
    <input type="text" placeholder="Buscar n.º pedido" [(ngModel)]="searchTerm" />
    <select [(ngModel)]="estadoFilter">
      <option value="">Todos</option>
      <option *ngFor="let est of estadosUnicos" [value]="est">{{ est }}</option>
    </select>
    <button type="button" class="btn-export" (click)="exportCSV()">Exportar CSV</button>
  </div>

  <div *ngIf="!isLoading && !errorMensaje && filteredPedidos.length > 0" class="orders-grid" role="region">
    <article *ngFor="let pedido of paginatedPedidos; trackBy: trackByPedidoId" class="order-row order-card" role="region" tabindex="0" [attr.aria-labelledby]="'order-' + getPedidoId(pedido)" [@fadeSlideIn]>
      <div class="detail-column">
        <h2 id="order-{{getPedidoId(pedido)}}"><span class="material-icons book-icon">menu_book</span>Pedido #{{ getPedidoId(pedido) }}</h2>
        <p><strong>Fecha:</strong> {{ pedido.fecha | date:'dd/MM/yyyy' }}</p>
        <p><strong>Estado:</strong>
          <span class="status" [ngClass]="'status-' + pedido.estado.toLowerCase().replace(' ', '-')">{{ pedido.estado }}</span>
        </p>
        <p><strong>Total:</strong> {{ pedido.total | currency:'USD':'symbol':'1.2-2' }}</p>
        <button *ngIf="pedido.estado === 'PAGADO'; else pagoBoton" class="btn-detail" (click)="verDetalle(getPedidoId(pedido))" [attr.aria-label]="'Ver detalle del pedido ' + getPedidoId(pedido)">Ver detalle</button>
        <ng-template #pagoBoton>
          <button class="btn-pay" (click)="irAPago(getPedidoId(pedido))" [attr.aria-label]="'Pagar pedido ' + getPedidoId(pedido)">Pagar</button>
        </ng-template>
        <button class="btn-pdf" (click)="descargarPDF(getPedidoId(pedido))">Descargar PDF</button>
        <button *ngIf="pedido.estado === 'ENTREGADO'" class="btn btn-outline" (click)="dejarResena(getPedidoId(pedido))">Valorar</button>
      </div>
    </article>
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="btn" (click)="changePage(-1)" [disabled]="currentPage === 1">Anterior</button>
      <span>{{currentPage}} / {{totalPages}}</span>
      <button class="btn" (click)="changePage(1)" [disabled]="currentPage === totalPages">Siguiente</button>
    </div>
  </div>
</div>
