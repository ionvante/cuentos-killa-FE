<div class="detalle-pagina">
  <div class="detalle-grid">
    <div class="hero">
      <div class="badges">
        <span class="badge category" *ngIf="cuento?.categoria">{{ cuento?.categoria }}</span>
        <span class="badge nuevo" *ngIf="badgeLabel==='Nuevo'">Nuevo</span>
        <span class="badge top" *ngIf="badgeLabel && badgeLabel!=='Nuevo'">{{ badgeLabel }}</span>
        <span class="badge oferta" *ngIf="hasDiscount">-{{ cuento?.descuento }}% OFF</span>
      </div>
      <div class="imagen-skeleton" *ngIf="cargandoImagen"></div>
      <img
        [appLazyLoad]="cuento?.imagenUrl || 'assets/placeholder-cuento.jpg'"
        alt="Imagen del cuento"
        (error)="cargarImagenPlaceholder($event)"
        (load)="imagenCargada()"
        [class.loaded]="!cargandoImagen"
      />
    </div>

  <div class="detalle-info">
    <button class="back-btn" type="button" (click)="volver()">
      <span class="material-icons">arrow_back</span>
    </button>
    <h1>{{ cuento?.titulo }}</h1>
    <div class="autor-precio">
      <h3>Autor: {{ cuento?.autor }}</h3>
      <div class="precio">
        <span class="original" *ngIf="hasDiscount">S/ {{ cuento?.precio | number:'1.2-2' }}</span>
        <span class="final">S/ {{ precioFinal | number:'1.2-2' }}</span>
      </div>
    </div>
    <div class="meta">
      <span class="edad" *ngIf="cuento?.edadRecomendada">Edad: {{ cuento?.edadRecomendada }}+</span>
      <span class="envio" *ngIf="cuento?.envioGratis">üöö Env√≠o gratis desde S/ {{ minFreeShipping }}</span>
    </div>
    <div class="rating" *ngIf="cuento?.rating != null" [attr.aria-label]="(cuento?.rating ?? 0) + ' de 5'">
      <span class="stars">{{ getRatingStars(cuento?.rating ?? 0) }}</span>
      <span class="count" *ngIf="cuento?.ratingCount as rc">({{ rc }})</span>
    </div>
    <blockquote class="testimonial">
      ‚ÄúUn viaje m√°gico para toda la familia‚Äù ‚Äì Carla R.
    </blockquote>
    <p class="stock" [ngClass]="{ 'low-stock': lowStock }">{{ stockMessage }}</p>
    <p class="descripcion">{{ cuento?.descripcionCorta }}</p>

    <button class="tech-toggle" (click)="toggleTech()" aria-controls="tech-panel" [attr.aria-expanded]="openTech">Ficha t√©cnica</button>
    <div class="extra-info" id="tech-panel" [hidden]="!openTech">
      <p><strong>Editorial:</strong> {{ cuento?.editorial }}</p>
      <p><strong>Tipo de Edici√≥n:</strong> {{ cuento?.tipoEdicion }}</p>
      <p><strong>P√°ginas:</strong> {{ cuento?.nroPaginas }}</p>
      <p><strong>Publicado en:</strong> {{ cuento?.fechaPublicacion | date }}</p>
      <p><strong>Edad Recomendada:</strong> {{ cuento?.edadRecomendada }}</p>
    </div>

    <div class="acciones">
      <button class="btn btn-primary" (click)="agregarAlCarrito(); $event.stopPropagation()" [disabled]="!cuento?.habilitado">
        Agregar al carrito
      </button>
      <button class="btn btn-secondary" (click)="volver(); $event.stopPropagation()">Volver</button>
      <div class="share">
        <button aria-label="Compartir en WhatsApp" (click)="compartir('whatsapp')">
          <img appLazyLoad="assets/whatsapp.svg" alt="WhatsApp">
        </button>
        <button aria-label="Compartir en TikTok" (click)="compartir('tiktok')">
          <img appLazyLoad="assets/tiktok.svg" alt="TikTok">
        </button>
      </div>
    </div>
  </div>

  <section class="relacionados" *ngIf="relatedCuentos.length">
    <h2>Te puede interesar</h2>
    <div class="carousel-wrapper">
      <button class="prev" aria-label="Anterior" (click)="scrollCarousel(-1)">‚Äπ</button>
      <div class="carousel" #carousel>
        <div class="slide" *ngFor="let book of relatedCuentos">
          <div class="card">
            <img appLazyLoad="{{ book.imagenUrl || 'assets/placeholder-cuento.jpg' }}" alt="{{ book.titulo }}" class="w-full rounded-lg" />
            <p class="titulo">{{ book.titulo }}</p>
            <p class="precio">S/ {{ book.precio | number:'1.2-2' }}</p>
          </div>
        </div>
      </div>
      <button class="next" aria-label="Siguiente" (click)="scrollCarousel(1)">‚Ä∫</button>
    </div>
  </section>
  <div class="sticky-cta" *ngIf="cuento">
    <span class="price">S/ {{ precioFinal | number:'1.2-2' }}</span>
    <button class="btn btn-primary" (click)="agregarAlCarrito(); $event.stopPropagation()" [disabled]="!cuento.habilitado">A√±adir al carrito</button>
  </div>
</div>

